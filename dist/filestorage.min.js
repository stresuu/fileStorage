!function(e,t){"use strict";var n={Base:"storage",RequestQuota:1073741824,support:[],objectStore:{name:e,version:1,store:{file:"file"}}},o={setting:{readAs:["readAsText","readAsArrayBuffer","readAsDataURL","readAsBinaryString","createObjectURL"],extension:{mp3:{ContentType:"audio/mp3"},mp4:{ContentType:"audio/mp4"},txt:{ContentType:"text/plain"},css:{ContentType:"text/css"},avi:{ContentType:"video/x-msvideo"},html:{ContentType:"text/html"},mxml:{ContentType:"application/xv+xml"},rss:{ContentType:"application/rss+xml"},xml:{ContentType:"application/xml"},js:{ContentType:"application/javascript"},json:{ContentType:"application/json"},xhtml:{ContentType:"application/xhtml+xml"},pdf:{ContentType:"application/pdf"},jpg:{ContentType:"image/jpeg"},jpeg:{ContentType:"image/jpeg"},png:{ContentType:"image/png"},other:{ContentType:"text/plain",Charset:"UTF-8",fileName:"Uknown",fileExtension:""}}},message:{RequestFileSystem:"requestFileSystem API supported!",IndexedDBAPI:"No requestFileSystem API but IndexedDB will be used to store!",NoRequestFileSystem:"No requestFileSystem API!",NoURLProvided:"no URL provided",NoFileFound:"no File found",Fail:"Fail",UnknownError:"Unknown Error",PleaseSeeStatus:"Please see {status}!"},userCallback:{before:function(){},progress:function(){}},mergeObject:function(e){for(var t,n=arguments,o=Object(e),r=1;r<n.length;r++)if(n[r].constructor===Object)for(var s in n[r])try{t?o.hasOwnProperty(s)?o[s].constructor===Array?o[s]=this.mergeArray(o[s],n[r][s]):o[s].constructor===Object&&(o[s]=this.mergeObject(o[s],n[r][s])):o[s]=n[r][s]:o[s].constructor===Array?o[s]=this.mergeArray(o[s],n[r][s]):o[s].constructor===Object?o[s]=this.mergeObject(o[s],n[r][s]):o[s]=n[r][s]}catch(e){o[s]=n[r][s]}else 1===r&&(t=n[r]);return o},mergeArray:function(e){for(var t=arguments,n=1;n<t.length;n++)t[n].constructor===Array&&(e=e.concat(t[n]).filter(function(e,t,n){return n.indexOf(e)===t}));return e},hasCallback:function(e,t){return"object"==typeof e&&"function"==typeof e[t]},hasCallbackMethod:function(e,t){return this.hasCallback(e,t)?e[t]:new Function},createBlob:function(e){e.blob||(e.data?e.dataType||(e.blob=new Blob([e.data],{type:e.fileType})):e.blob=new Blob([e.fileContent],{type:e.fileType}))},readBlob:function(e,n){return new Promise(function(o,r){try{var s=new FileReader;switch(s.onabort=function(e){r(e)},s.onerror=function(e){r(e)},s.onload=function(e){o(s.result)},n){case"readAsDataURL":s.readAsDataURL(e);break;case"readAsText":s.readAsText(e);break;case"readAsArrayBuffer":s.readAsArrayBuffer(e);break;case"readAsBinaryString":s.readAsBinaryString(e);break;default:o(t.URL.createObjectURL(e)),t.URL.revokeObjectURL()}}catch(e){r(e)}})},afterDownload:function(e){return e.data.constructor!==Blob?e.blob=new Blob([e.data.constructor===Object?JSON.stringify(e.data,null,2):e.data],{type:e.fileType}):e.blob=e.data,new Promise(function(t,n){o.readBlob(e.blob,e.readAs).then(function(n){e.fileContent=n,t(e)},function(e){n(e)})})},dirChecker:function(e){return!!e&&e.split("/").slice(0,-1)},dirCreator:function(e,t,n){"."!=t[0]&&""!=t[0]||(t=folders.slice(1)),t.length?e.getDirectory(t[0],{create:!0},function(e){t.length?o.dirCreator(e,t.slice(1),n):n(!0)},function(e){n(!1,e)}):n(!0)},fileWriter:function(e,t){return new Promise(function(n,o){e.createWriter(function(e){e.onwriteend=function(e){this.onwriteend=null,this.truncate(this.position),n(e)},e.onerror=function(e){o(e)},e.write(t)},function(e){o(e)})})},fileCreator:function(){},fileReader:function(){},fileRemover:function(){},initiate:{start:function(e,t){return o.database.start().then(function(e){return e},function(){return!1}).then(function(r){o.initiate.Chrome(e,function(){o.initiate.Cordova(e,function(s){r?(n.message=o.message.IndexedDBAPI,e(r)):t(s)})})})},Chrome:function(e,r){try{navigator.webkitPersistentStorage.requestQuota(n.RequestQuota,function(s){n.ResponseQuota=s,t.requestfileStorage=t.webkitRequestFileSystem,t.resolvefileStorage=t.webkitResolveLocalFileSystemURL,n.PERSISTENT=t.PERSISTENT,n.TEMPORARY=t.TEMPORARY;try{t.requestfileStorage(n.Permission>0?n.PERSISTENT:n.TEMPORARY,s,function(t){n.support.push("storage"),Object.defineProperty(o.user,"storage",{enumerable:!1,value:t.root}),e(t)},function(e){r(e)})}catch(e){r(e)}},function(e){r(e)})}catch(e){r(e)}},Cordova:function(e,r){try{t.requestfileStorage=t.requestFileSystem,t.resolvefileStorage=t.resolveLocalFileSystemURL,t.requestfileStorage?("LocalFileSystem"in t?(n.PERSISTENT=LocalFileSystem.PERSISTENT,n.TEMPORARY=LocalFileSystem.TEMPORARY):(n.PERSISTENT=t.PERSISTENT,n.TEMPORARY=t.TEMPORARY),t.requestfileStorage(n.Permission>0?n.PERSISTENT:n.TEMPORARY,n.RequestQuota,function(t){n.support.push("storage"),Object.defineProperty(o.user,"storage",{enumerable:!1,value:t.root}),e(t)},function(e){r(e)})):r(o.message.NoRequestFileSystem)}catch(e){r(e)}}},database:{start:function(){return new Promise(function(e,t){n.objectStore?o.database.IndexedDB().then(function(t){e(t)},function(e){t(e)}):o.database.localStorage().then(function(t){e(t)},function(e){t(e)})})},IndexedDB:function(){return new Promise(function(e,r){Object.defineProperty(o.user,"db",{enumerable:!1,value:t.indexedDB||t.mozIndexedDB||t.webkitIndexedDB||t.msIndexedDB});try{var s=o.user.db.open(n.objectStore.name,n.objectStore.version);s.onerror=function(){r(this.error)},s.onupgradeneeded=function(){var e=n.objectStore.store;if("object"==typeof e)for(var t in e)if(e.hasOwnProperty(t)){var o=e[t];if("object"==typeof o&&o.hasOwnProperty("name")){var r=o.name;this.result.objectStoreNames.contains(r)||("object"==typeof o.option?this.result.createObjectStore(r,o.option):this.result.createObjectStore(r))}else"string"==typeof o&&(this.result.objectStoreNames.contains(o)||this.result.createObjectStore(o))}},s.onsuccess=function(t){var r=n.objectStore.store.file;"object"==typeof r&&r.hasOwnProperty("name")&&(n.objectStore.store.file=r.name),n.support.push("database"),Object.defineProperty(o.user,"database",{enumerable:!1,value:t.target.result}),e(this.result)}}catch(e){r(e)}})},localStorage:function(){return new Promise(function(e,n){try{Object.defineProperty(o.user,"db",{enumerable:!1,value:t.localStorage}),e()}catch(e){n(e)}})}},open:function(e,t){return o.openRequest(e,t)},openRequest:function(e,t){return e&&"object"==typeof e&&this.mergeObject(n,e),this.ready.constructor===Function?this.ready(t):this.user},ready:function(e){return this.ready=new Promise(function(e,t){o.initiate.start(function(t){-1==n.support.indexOf(n.Base)&&(n.Base=n.support[0]),Object.defineProperties(o.user,{file:{enumerable:!1,value:o.file[n.Base]}}),n.message||(n.message=o.message.RequestFileSystem),e(o.user[n.Base])},function(e){"string"==typeof e?n.message=e:e.message?(n.message=e.message,e.name&&(n.name=e.name),e.code&&(n.status=e.code)):(n.status=e,n.message=o.message.PleaseSeeStatus),t(n)})}).then(function(t){o.hasCallbackMethod(e,"success").call(o.user,t)},function(t){o.hasCallbackMethod(e,"fail")(t)}).then(function(){return o.hasCallbackMethod(e,"done").call(o.user,n),o.user}),this.user},file:{storage:{save:function(e){return new Promise(function(t,n){try{o.createBlob(e),o.user.storage.getFile(e.urlLocal,{create:!0},function(r){o.fileWriter(r,e.blob).then(function(e){t(e)},function(e){n(e)})},function(r){var s=o.dirChecker(e.urlLocal);s.length?o.dirCreator(o.user.storage,s,function(r,s){r?o.user.storage.getFile(e.urlLocal,{create:!0,exclusive:!0},function(r){o.fileWriter(r,e.blob).then(function(e){t(e)},function(e){n(e)})},function(e){n(e)}):n(s)}):n(r)})}catch(e){n(e)}})},open:function(e){return new Promise(function(t,n){o.user.storage.getFile(e.urlLocal,{create:!1},function(r){r.file(function(r){o.readBlob(r,e.readAs).then(function(n){e.fileSize=r.size,e.fileExtension=r.name.split(".").pop(),r.type?e.fileType=r.type:e.fileExtension&&o.setting.extension[e.fileExtension]&&(e.fileType=o.setting.extension[e.fileExtension].ContentType),e.fileContent=n,t(e)},function(e){n(e)})},function(e){n(e)})},function(e){n(e)})})},delete:function(e){return new Promise(function(t,n){o.user.storage.getFile(e.urlLocal,{create:!1},function(e){e.remove(function(e){t()},function(e){n(e)})},function(o){e.fileNotFound?t():n(o)})})},name:"storage"},database:{save:function(e){return new Promise(function(t,r){try{var s=n.objectStore.store.file,i=o.user.database.transaction([s],"readwrite"),a=i.objectStore(s);o.createBlob(e),i.oncomplete=function(e){t(e)},i.onerror=function(e){r(e)},a.put(e.blob,e.urlLocal)}catch(e){r(e)}})},open:function(e){return new Promise(function(t,r){try{var s=n.objectStore.store.file,i=o.user.database.transaction([s],"readwrite").objectStore(s).openCursor(e.urlLocal);i.onerror=function(e){r(e)},i.onsuccess=function(n){var s=this.result;s?o.readBlob(s.value,e.readAs).then(function(n){e.fileContent=n,e.fileSize=s.value.size,e.fileExtension=e.urlLocal.split(".").pop(),s.value.type?e.fileType=s.value.type:e.fileExtension&&o.setting.extension[e.fileExtension]&&(e.fileType=o.setting.extension[e.fileExtension].ContentType),t(e)},function(e){r(e)}):r({message:o.message.NoFileFound})}}catch(e){r(e)}})},delete:function(e){return new Promise(function(t,r){try{var s=n.objectStore.store.file,i=o.user.database.transaction([s],"readwrite").objectStore(s).delete(e.urlLocal);i.onerror=function(e){r(e)},i.onsuccess=function(e){t(e)}}catch(e){r(e)}})},name:"database"}},user:{download:function(e){return o.ready.then(function(r){return new Promise(function(s,i){var a=t.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),u=0;a.addEventListener("progress",function(t){u++,o.hasCallback(e,"progress")&&(t.lengthComputable?(u=Math.floor(t.loaded/t.total*100),e.progress(u)):a.readyState==XMLHttpRequest.DONE?e.progress(100):200!=a.status?(e.progress(Math.floor(u/7*100)),u++):e.progress(100))},!1),a.addEventListener("load",function(t){if(e.urlResponse=a.responseURL,e.fileName=e.url.replace(/[\#\?].*$/,"").substring(e.url.lastIndexOf("/")+1),e.fileExtension=e.fileName.split(".").pop(),e.urlLocal)if(!0===e.urlLocal){var u=e.url.match(/\/\/[^\/]+\/([^\.]+)/);e.urlLocal=u?u[1].replace(/[\#\?].*$/,""):e.url.replace(/[\#\?].*$/,"")}else e.urlLocal=e.urlLocal.replace(/[\#\?].*$/,"");else e.urlLocal=e.fileName;e.fileCharset="UTF-8",e.fileSize=t.total,e.data=a.response,o.setting.extension[e.fileExtension]&&(e.fileType=o.setting.extension[e.fileExtension].ContentType),a.responseType?(e.dataType=a.responseType,e.fileType=a.response.type?a.response.type:e.fileType):(a.responseXML&&(e.fileCharset=a.responseXML.charset,e.fileType=a.responseXML.contentType,e.xml=a.responseXML),e.fileContent=a.responseText),200==a.status||0==a.status?(delete e.before,delete e.progress,o.afterDownload(e).then(function(){"object"==typeof e.fileOption&&!0===e.fileOption.create&&e.urlLocal&&n.support.length?r.file.save(e).then(function(t){e.fileCreation=!0,e.api=t,s(e)},function(e){i(e)}):s(e)},function(e){i(e)})):a.statusText?i({message:a.statusText+": "+e.url,code:a.status}):a.status?i({message:o.message.Fail,code:a.status}):i({message:o.message.UnknownError})},!1),a.addEventListener("error",function(e){i(e)},!1),a.addEventListener("abort",function(e){i(e)},!1),e.requestCache?e.urlRequest=e.url+(e.url.indexOf("?")>0?"&":"?")+"_="+(new Date).getTime():e.urlRequest=e.url,e.url?(a.open(e.requestMethod?e.requestMethod:"GET",e.urlRequest,!0),o.hasCallbackMethod(e,"before")(a),a.send()):i({message:o.message.NoURLProvided})})})},save:function(e){return o.ready.then(function(t){return t.file.save(e)})},open:function(e){return o.ready.then(function(t){return t.file.open(e)})},delete:function(e){return o.ready.then(function(t){return t.file.delete(e)})},browse:function(e){return o.ready.then(function(e){})}}};t[e]=o.open}("fileStorage",window);